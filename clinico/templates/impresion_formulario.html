{% load static %}
{% load clinico_tags %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IMPRESIÓN - {{ f.codigo }}</title>
    <style>
        @page {
            size: A4 portrait;
            margin: 1cm;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 9pt;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }
        th, td {
            border: 1px solid #000;
            padding: 4px 6px;
        }
        
        /* Encabezado */
        .header-table td {
            padding: 10px;
        }
        .logo-cell {
            width: 150px;
            text-align: center;
        }
        .logo-img {
            max-width: 120px;
            max-height: 60px;
        }
        .title-cell {
            text-align: center;
        }
        .title-cell h1 {
            margin: 0;
            font-size: 14pt;
            color: #444;
        }
        .meta-cell {
            width: 180px;
            font-size: 8pt;
        }
        
        /* Info Paciente */
        .info-label {
            font-weight: bold;
            background-color: #f3f4f6;
            width: 15%;
        }
        .info-value {
            width: 35%;
        }
        
        /* Grid de Mediciones */
        .grid-table {
            table-layout: fixed;
        }
        .grid-table th {
            background-color: #3b82f6;
            color: white;
            font-size: 8pt;
            text-align: center;
        }
        .grid-table .time-col {
            width: 8.4%;
        }
        .grid-table .item-col {
            width: 16%;
        }
        .section-row {
            background-color: #e5e7eb;
            font-weight: bold;
            text-transform: uppercase;
        }
        .param-name {
            font-weight: 500;
            font-size: 8pt;
        }
        .valor-celda {
            text-align: center;
            font-size: 8pt;
            height: 25px;
            vertical-align: middle;
        }
        .multi-campo {
            font-size: 7pt;
            border-bottom: 1px solid #eee;
        }
        .multi-campo:last-child {
            border-bottom: none;
        }
        
        @media print {
            .no-print {
                display: none;
            }
            body {
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body onload="window.print(); setTimeout(window.close, 500);">
    <div class="container">
        <!-- Encabezado Institucional -->
        <table class="header-table">
            <tr>
                <td class="logo-cell">
                    <img src="{% static 'img/logo_hospital.png' %}" class="logo-img" alt="Logo">
                </td>
                <td class="title-cell">
                    <h1>CONTROL DE TRABAJO DE PARTO</h1>
                </td>
                <td class="meta-cell">
                    <b>CÓDIGO:</b> {{ f.codigo }}<br>
                    <b>VERSIÓN:</b> {{ f.version }}<br>
                    <b>HOJA:</b> {{ f.num_hoja }} DE 1<br>
                    <b>FECHA:</b> {{ f.fecha_elabora|date:"d/m/Y" }}
                </td>
            </tr>
        </table>

        <!-- Datos del Paciente -->
        <table>
            <tr>
                <td class="info-label">PACIENTE:</td>
                <td class="info-value" colspan="3">{{ p.nombres }}</td>
            </tr>
            <tr>
                <td class="info-label">IDENTIFICACIÓN:</td>
                <td class="info-value">{{ p.num_identificacion }}</td>
                <td class="info-label">H. CLÍNICA:</td>
                <td class="info-value">{{ p.num_historia_clinica }}</td>
            </tr>
            <tr>
                <td class="info-label">ASEGURADORA:</td>
                <td class="info-value">{{ f.aseguradora.nombre|default:"N/A" }}</td>
                <td class="info-label">EDAD:</td>
                <td class="info-value">{{ f.edad_snapshot }} años</td>
            </tr>
            <tr>
                <td class="info-label">DIAGNÓSTICO:</td>
                <td class="info-value" colspan="3">{{ f.diagnostico|default:"—" }}</td>
            </tr>
        </table>

        <!-- Grid Principal -->
        <table class="grid-table">
            <thead>
                <tr>
                    <th class="item-col" rowspan="2">ÍTEM / PARÁMETRO</th>
                    <th colspan="10">HORA DE CONTROL</th>
                </tr>
                <tr>
                    {% for h in horas %}
                        <th class="time-col">{{ h|date:"H:i" }}</th>
                    {% endfor %}
                    {% for i in "1234567890"|make_list %}
                        {% if forloop.counter > horas|length %}
                            <th class="time-col"></th>
                        {% endif %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr class="section-row">
                        <td colspan="11">{{ item.nombre }}</td>
                    </tr>
                    {% for param in item.parametros.all %}
                        <tr>
                            <td class="param-name">{{ param.nombre }}</td>
                            {% for h in horas %}
                                <td class="valor-celda">
                                    {% with grid_data|get_item:param.id as p_data %}
                                        {% with p_data|get_item:h.isoformat as h_data %}
                                            {% for campo in param.campos.all %}
                                                <div class="{% if param.campos.count > 1 %}multi-campo{% endif %}">
                                                    {{ h_data|get_item:campo.id|default:"—" }}
                                                </div>
                                            {% endfor %}
                                        {% endwith %}
                                    {% endwith %}
                                </td>
                            {% endfor %}
                            <!-- Celdas vacías para completar las 10 columnas -->
                            {% for i in "1234567890"|make_list %}
                                {% if forloop.counter > horas|length %}
                                    <td></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>

        <!-- Responsable -->
        <table style="margin-top: 20px; border: none;">
            <tr>
                <td style="border: none;">
                    <b>RESPONSABLE:</b> {{ f.responsable }}
                </td>
            </tr>
        </table>
    </div>
</body>
</html>

